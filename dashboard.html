<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Dashboard - NkwaBiz</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.min.js"></script>
    <script src="api.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f7f7f8;
            color: #222;
            margin: 0
        }

        .container {
            max-width: 900px;
            margin: 40px auto;
            padding: 20px
        }

        .card {
            background: transparent;
            padding: 18px 0;
            border-radius: 0;
            box-shadow: none;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 8px
        }

        h2 {
            font-size: 20px;
            margin-bottom: 8px
        }

        p {
            color: #555
        }

        .btn {
            background: #000;
            color: #fff;
            border: none;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .muted {
            color: #777
        }

        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px
        }

        .topbar .signup-btn {
            background: transparent;
            color: #000;
            border: 1px solid #000;
            padding: 8px 10px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
        }

        .topbar .signup-btn:hover {
            background: #000;
            color: #fff;
        }

        .topbar .top-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .actions-row {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .table-responsive {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 8px;
            background: #fff;
        }

        table.responsive-table th,
        table.responsive-table td {
            white-space: nowrap;
            padding: 8px;
        }

        @media (max-width:600px) {
            .container {
                padding: 12px;
                margin: 20px auto;
            }

            .actions-row {
                gap: 8px;
            }

            .btn {
                padding: 8px 10px;
                font-size: 14px
            }

            table.responsive-table th,
            table.responsive-table td {
                padding: 6px;
                font-size: 13px
            }
        }

        .form-input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            width: 100%;
            box-sizing: border-box;
        }

        .status {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        textarea {
            font-family: inherit;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        input[type="file"] {
            padding: 8px 0;
        }
    </style>
</head>

<body>
    <div id="app">
        <div class="container">
            <div class="topbar">
                <div><strong>NkwaBiz</strong></div>
                <div style="display:flex; gap:12px; align-items:center;">
                    <div class="muted">{{ businessDisplay }}</div>
                    <a v-if="!business" href="auth.html" class="signup-btn">Sign up</a>
                    <button v-if="business" @click="signout" class="btn">Sign out</button>
                </div>
            </div>
            <div class="card">
                <h1>{{ welcomeTitle }}</h1>
                <p>{{ subtitle }}</p>
            </div>
            <div class="card" style="margin-top:16px">
                <h2>Your products</h2>
                <div class="actions-row">
                    <div class="top-actions">
                        <button class="btn" @click="togglePostForm">{{ postFormButtonText }}</button>
                        <button class="btn" @click="toggleBulk">{{ bulkButtonText }}</button>
                    </div>
                    <div class="muted">Manage your product inventory and analytics here.</div>
                </div>
                <div v-if="showPostForm" style="margin-top:12px; padding:8px 0">
                    <form @submit.prevent="postProduct" style="display:grid; gap:8px; max-width:520px">
                        <input v-model="newProduct.product_name" placeholder="Product name" required class="form-input">
                        <input v-model.number="newProduct.selling_price" placeholder="Selling price" required
                            class="form-input" type="number" step="0.01">
                        <input v-model.number="newProduct.initial_stock" placeholder="Initial stock" required
                            class="form-input" type="number">
                        <input v-model="newProduct.expiration_date" placeholder="Expiration date (YYYY-MM-DD)"
                            class="form-input" type="date">
                        <input v-model="newProduct.supplier_info" placeholder="Supplier info" class="form-input">
                        <div style="display:flex; gap:8px; margin-top:6px; flex-wrap:wrap; align-items:center">
                            <button class="btn" type="submit" :disabled="posting">{{ submitButtonText }}</button>
                            <div v-if="postMessage" :class="['status', postMessageType]">{{ postMessage }}</div>
                        </div>
                    </form>
                </div>
                <div style="margin-top:12px">
                    <button class="btn" @click="toggleBulk">{{ bulkButtonText }}</button>
                </div>
                <div v-if="showBulk" style="margin-top:12px; max-width:720px">
                    <p class="muted">Upload CSV with header row
                        (product_name,selling_price,initial_stock,expiration_date,supplier_info) or paste lines.</p>
                    <input type="file" accept=".csv,text/csv" @change="onFileChange">
                    <textarea v-model="bulkText" rows="6"
                        placeholder="product_name,selling_price,initial_stock,expiration_date,supplier_info&#10;Product A,10.50,100,2025-12-31,Supplier X"
                        style="width:100%; margin-top:8px; padding:8px; box-sizing:border-box"></textarea>
                    <div style="display:flex; gap:8px; margin-top:8px; align-items:center; flex-wrap:wrap">
                        <button class="btn" @click="startBulk" :disabled="bulkPosting">{{ bulkStartButtonText
                            }}</button>
                        <div class="muted">{{ bulkStatus }}</div>
                    </div>
                    <div v-if="bulkResults.length" style="margin-top:12px">
                        <div v-for="(r, i) in bulkResults" :key="i" style="padding:6px 0; border-bottom:1px solid #eee">
                            <div><strong>{{ r.product_name || '(no name)' }}</strong> — <span
                                    :style="{ color: r.ok ? '#155724' : '#721c24' }">{{ r.ok ? 'OK' : 'ERROR' }}</span>
                            </div>
                            <div v-if="r.message" class="muted">{{ r.message }}</div>
                        </div>
                    </div>
                </div>
                <div v-if="loading" style="padding:18px">Loading data...</div>
                <div v-if="errorMessage" :class="['status','error']" style="margin-top:12px">{{ errorMessage }}</div>
                <div v-if="!loading && products.length === 0" style="padding:18px" class="muted">No product analytics
                    available yet.</div>
                <div v-if="products.length > 0" style="margin-top:12px">
                    <table
                        style="width:100%; border-collapse:collapse; background:#fff; border-radius:8px; overflow:hidden;">
                        <thead style="background:#f2f2f2;">
                            <tr>
                                <th style="text-align:left; padding:8px; border-bottom:1px solid #eee;">Product Name
                                </th>
                                <th style="text-align:left; padding:8px; border-bottom:1px solid #eee;">Selling Price
                                </th>
                                <th style="text-align:left; padding:8px; border-bottom:1px solid #eee;">Initial Stock
                                </th>
                                <th style="text-align:left; padding:8px; border-bottom:1px solid #eee;">Remaining Stock
                                </th>
                                <th style="text-align:left; padding:8px; border-bottom:1px solid #eee;">Expiration Date
                                </th>
                                <th style="text-align:left; padding:8px; border-bottom:1px solid #eee;">Supplier Info
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(p, idx) in products" :key="idx" style="border-bottom:1px solid #eee;">
                                <td style="padding:8px; font-weight:700;">{{ p.product_name || 'Unnamed product' }}</td>
                                <td style="padding:8px;">¢{{ formatNumber(p.selling_price) }}</td>
                                <td style="padding:8px;">{{ p.initial_stock }}</td>
                                <td style="padding:8px;">{{ p.remaining_stock }}</td>
                                <td style="padding:8px;">{{ formatDate(p.expiration_date) }}</td>
                                <td style="padding:8px;">{{ p.supplier_info || '-' }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <script>
        try {
            const { createApp } = Vue;
            createApp({
                data() {
                    return {
                        business: '',
                        welcomeTitle: 'Welcome',
                        subtitle: "This is your dashboard. We'll build features here next.",
                        loading: false,
                        errorMessage: '',
                        products: [],
                        showPostForm: false,
                        posting: false,
                        postMessage: '',
                        postMessageType: '',
                        newProduct: {
                            product_name: '',
                            selling_price: '',
                            initial_stock: '',
                            expiration_date: '',
                            supplier_info: ''
                        },
                        showBulk: false,
                        bulkText: '',
                        bulkPosting: false,
                        bulkStatus: '',
                        bulkResults: []
                    }
                },
                computed: {
                    businessDisplay() {
                        return this.business || 'Not signed in';
                    },
                    postFormButtonText() {
                        return this.showPostForm ? 'Cancel' : 'Post product';
                    },
                    submitButtonText() {
                        return this.posting ? 'Posting...' : 'Submit product';
                    },
                    bulkButtonText() {
                        return this.showBulk ? 'Hide bulk uploader' : 'Post many products';
                    },
                    bulkStartButtonText() {
                        return this.bulkPosting ? 'Posting...' : 'Start bulk post';
                    }
                },
                mounted() {
                    try {
                        this.business = sessionStorage.getItem('nkwabiz_business') || '';
                    } catch (e) {
                        this.business = '';
                        console.warn('Could not access sessionStorage', e);
                    }
                    if (this.business) {
                        this.subtitle = `Business: ${this.business}`;
                        this.loadAnalytics();
                    }
                },
                methods: {
                    togglePostForm() {
                        this.showPostForm = !this.showPostForm;
                    },
                    toggleBulk() {
                        this.showBulk = !this.showBulk;
                    },
                    formatNumber(v) {
                        if (v == null || v === '') return '-';
                        return Number(v).toLocaleString();
                    },
                    formatDate(d) {
                        if (!d) return '-';
                        const dt = new Date(d);
                        if (isNaN(dt)) return d;
                        return dt.toLocaleDateString();

                    },
                    async loadAnalytics() {
                        this.loading = true;
                        this.errorMessage = '';
                        try {
                            const resp = await apiFetch('https://saas-tool-mf02.onrender.com/dashboard/board', { method: 'GET' });
                            if (!resp.ok) {
                                let body = '';
                                try { body = await resp.text(); } catch (e) { }
                                this.errorMessage = `Failed to load analytics (status ${resp.status}).`;
                                console.warn('analytics load failed', resp.status, body);
                                return;
                            }
                            const data = await resp.json().catch(() => null);
                            if (Array.isArray(data)) {
                                this.products = data;
                            } else if (data && data.product_name) {
                                this.products = [data];
                            } else if (data && data.products && Array.isArray(data.products)) {
                                this.products = data.products;
                            } else {
                                this.products = [];
                            }
                        } catch (err) {
                            console.error('loadAnalytics error', err);
                            this.errorMessage = 'Network error while loading analytics.';
                        } finally {
                            this.loading = false;
                        }
                    },
                    async postProduct() {
                        this.posting = true;
                        this.postMessage = '';
                        this.postMessageType = '';
                        try {
                            const payload = {
                                product_name: this.newProduct.product_name,
                                selling_price: this.newProduct.selling_price,
                                initial_stock: this.newProduct.initial_stock,
                                expiration_date: this.newProduct.expiration_date,
                                supplier_info: this.newProduct.supplier_info
                            };
                            const resp = await apiFetch('https://saas-tool-mf02.onrender.com/product_view/product/post_product', {
                                method: 'POST',
                                body: JSON.stringify(payload)
                            });
                            const data = await resp.json().catch(() => ({}));
                            if (!resp.ok) {
                                const msg = data.message || `Failed to post product (status ${resp.status})`;
                                this.postMessage = msg;
                                this.postMessageType = 'error';
                                return;
                            }
                            this.postMessage = data.message || 'Product posted successfully.';
                            this.postMessageType = 'success';
                            this.newProduct = { product_name: '', selling_price: '', initial_stock: '', expiration_date: '', supplier_info: '' };
                            this.showPostForm = false;
                            this.loadAnalytics();
                        } catch (err) {
                            console.error('postProduct error', err);
                            this.postMessage = 'Network error while posting product.';
                            this.postMessageType = 'error';
                        } finally {
                            this.posting = false;
                        }
                    },
                    onFileChange(e) {
                        const f = e.target.files && e.target.files[0];
                        if (!f) return;
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                            this.bulkText = String(ev.target.result || '');
                        };
                        reader.readAsText(f);
                    },
                    parseCSV(text) {
                        const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
                        if (!lines.length) return [];
                        const header = lines[0].split(',').map(h => h.trim());
                        const rows = lines.slice(1).map(line => line.split(',').map(cell => cell.trim()));
                        return rows.map(cells => {
                            const obj = {};
                            for (let i = 0; i < header.length; i++) obj[header[i]] = cells[i] || '';
                            return obj;
                        });
                    },
                    async startBulk() {
                        const text = this.bulkText.trim();
                        if (!text) { this.bulkStatus = 'No CSV content'; return; }
                        this.bulkPosting = true;
                        this.bulkStatus = 'Parsing CSV...';
                        this.bulkResults = [];
                        try {
                            const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
                            let items = [];
                            if (lines[0] && lines[0].toLowerCase().includes('product_name')) {
                                items = this.parseCSV(text);
                            } else {
                                items = lines.map(line => {
                                    const c = line.split(',').map(s => s.trim());
                                    return {
                                        product_name: c[0] || '',
                                        selling_price: c[1] || '',
                                        initial_stock: c[2] || '',
                                        expiration_date: c[3] || '',
                                        supplier_info: c[4] || ''
                                    };
                                });
                            }
                            this.bulkStatus = `Posting ${items.length} items...`;
                            for (let i = 0; i < items.length; i++) {
                                const it = items[i];
                                try {
                                    const payload = {
                                        product_name: it.product_name,
                                        selling_price: it.selling_price,
                                        initial_stock: it.initial_stock,
                                        expiration_date: it.expiration_date,
                                        supplier_info: it.supplier_info
                                    };
                                    const resp = await apiFetch('https://saas-tool-mf02.onrender.com/product_view/product/post_product', {
                                        method: 'POST',
                                        body: JSON.stringify(payload)
                                    });
                                    const data = await resp.json().catch(() => ({}));
                                    if (!resp.ok) {
                                        this.bulkResults.push({ ...it, ok: false, message: data.message || `status ${resp.status}` });
                                    } else {
                                        this.bulkResults.push({ ...it, ok: true, message: data.message || 'OK' });
                                    }
                                } catch (err) {
                                    this.bulkResults.push({ ...it, ok: false, message: 'Network error' });
                                }
                                this.bulkStatus = `Posted ${i + 1}/${items.length}`;
                            }
                            this.bulkStatus = `Done: ${this.bulkResults.filter(r => r.ok).length} succeeded, ${this.bulkResults.filter(r => !r.ok).length} failed.`;
                            this.loadAnalytics();
                        } finally {
                            this.bulkPosting = false;
                        }
                    },
                    signout() {
                        try {
                            sessionStorage.removeItem('nkwabiz_token');
                            sessionStorage.removeItem('nkwabiz_business');
                        } catch (e) {
                            console.warn('Could not clear sessionStorage', e);
                        }
                        window.location.href = 'index.html';
                    }
                }
            }).mount('#app');
        } catch (e) {
            console.error('Dashboard init error', e);
            try {
                const node = document.createElement('pre');
                node.id = 'dashboard-error';
                node.style.background = '#fee';
                node.style.color = '#900';
                node.style.padding = '12px';
                node.style.margin = '20px';
                node.textContent = String(e && e.stack ? e.stack : e);
                document.body.insertBefore(node, document.body.firstChild);
            } catch (inner) { }
        }
    </script>
</body>

</html>