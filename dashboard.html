<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Dashboard - NkwaBiz</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.min.js"></script>
    <script src="api.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f7f7f8;
            color: #222;
            margin: 0
        }

        .container {
            max-width: 900px;
            margin: 40px auto;
            padding: 20px
        }

        .card {
            background: transparent;
            padding: 18px 0;
            border-radius: 0;
            box-shadow: none;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 8px
        }

        h2 {
            font-size: 20px;
            margin-bottom: 8px
        }

        p {
            color: #555
        }

        .btn {
            background: #000;
            color: #fff;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .muted {
            color: #777;
            font-size: 14px;
        }

        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .topbar .signup-btn {
            background: transparent;
            color: #000;
            border: 1px solid #000;
            padding: 8px 12px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
        }

        .topbar .signup-btn:hover {
            background: #000;
            color: #fff;
        }

        .topbar .top-actions {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .dot-btn {
            background: transparent;
            border: none;
            font-size: 20px;
            line-height: 1;
            cursor: pointer;
            padding: 6px 8px;
            color: #333;
            border-radius: 6px;
        }

        .dot-btn:hover {
            background: #f2f2f2
        }

        .menu-dropdown {
            position: absolute;
            right: 8px;
            top: 36px;
            background: #fff;
            border: 1px solid #eee;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
            border-radius: 6px;
            padding: 6px 6px;
            z-index: 50;
            min-width: 120px;
        }

        .menu-item {
            background: transparent;
            border: none;
            display: block;
            width: 100%;
            text-align: left;
            padding: 8px 6px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
        }

        .menu-item:hover {
            background: #f2f2f2
        }

        .actions-row {
            display: flex;
            gap: 16px;
            align-items: flex-start;
            flex-wrap: wrap;
            margin-top: 16px;
        }

        .button-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .form-input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            width: 100%;
            box-sizing: border-box;
        }

        .status {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        textarea {
            font-family: inherit;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        input[type="file"] {
            padding: 8px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
        }

        thead {
            background: #f2f2f2;
        }

        th {
            text-align: left;
            padding: 12px 8px;
            border-bottom: 2px solid #ddd;
            font-weight: 600;
            font-size: 14px;
        }

        td {
            padding: 12px 8px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        .table-wrapper {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-top: 16px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 16px;
                margin: 20px auto;
            }

            .actions-row {
                gap: 12px;
            }

            .button-group {
                gap: 8px;
                width: 100%;
            }

            .button-group .btn {
                flex: 1;
                min-width: 140px;
            }

            .topbar {
                gap: 10px;
            }

            .topbar .top-actions {
                gap: 8px;
            }

            h1 {
                font-size: 20px;
            }

            h2 {
                font-size: 18px;
            }

            .table-wrapper {
                margin-left: -16px;
                margin-right: -16px;
                width: calc(100% + 32px);
                padding: 0 16px;
            }

            table {
                min-width: 700px;
            }

            th,
            td {
                padding: 8px 6px;
                font-size: 13px;
                white-space: nowrap;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 12px;
                margin: 12px auto;
            }

            .btn {
                padding: 8px 12px;
                font-size: 13px;
            }

            .button-group .btn {
                min-width: 120px;
            }

            h1 {
                font-size: 18px;
            }

            h2 {
                font-size: 16px;
            }

            .table-wrapper {
                margin-left: -12px;
                margin-right: -12px;
                width: calc(100% + 24px);
                padding: 0 12px;
            }

            table {
                min-width: 650px;
            }

            th,
            td {
                padding: 6px 4px;
                font-size: 12px;
            }
        }
    </style>
</head>

<body>
    <div id="app">
        <div class="container">
            <div class="topbar">
                <div><strong>NkwaBiz</strong></div>
                <div class="top-actions">
                    <div class="muted">{{ businessDisplay }}</div>
                    <a v-if="!business" href="auth.html" class="signup-btn">Sign up</a>
                    <button v-if="business" @click="signout" class="btn">Sign out</button>
                </div>
            </div>

            <div class="card">
                <h1>{{ welcomeTitle }}</h1>
                <p>{{ subtitle }}</p>
            </div>

            <div class="card" style="margin-top:16px">
                <h2>Your products</h2>

                <div class="actions-row">
                    <div class="button-group">
                        <button class="btn" @click="togglePostForm">{{ postFormButtonText }}</button>
                        <button class="btn" @click="toggleBulk">{{ bulkButtonText }}</button>
                    </div>
                    <div class="muted" style="flex: 1; min-width: 200px;">Manage your product inventory and analytics
                        here.</div>
                </div>

                <div v-if="showPostForm" style="margin-top:16px; padding:12px 0">
                    <form @submit.prevent="postProduct" style="display:grid; gap:10px; max-width:520px">
                        <input v-model="newProduct.product_name" placeholder="Product name" required class="form-input">
                        <input v-model.number="newProduct.selling_price" placeholder="Selling price" required
                            class="form-input" type="number" step="0.01">
                        <input v-model.number="newProduct.initial_stock" placeholder="Initial stock" required
                            class="form-input" type="number">
                        <input v-model="newProduct.expiration_date" placeholder="Expiration date (YYYY-MM-DD)"
                            class="form-input" type="date">
                        <input v-model="newProduct.supplier_info" placeholder="Supplier info" class="form-input">
                        <div style="display:flex; gap:10px; margin-top:6px; flex-wrap:wrap; align-items:center">
                            <button class="btn" type="submit" :disabled="posting">{{ submitButtonText }}</button>
                            <div v-if="postMessage" :class="['status', postMessageType]">{{ postMessage }}</div>
                        </div>
                    </form>
                </div>

                <div v-if="showBulk" style="margin-top:16px; max-width:720px">
                    <p class="muted">Upload CSV with header row
                        (product_name,selling_price,initial_stock,expiration_date,supplier_info) or paste lines.</p>
                    <input type="file" accept=".csv,text/csv" @change="onFileChange" style="margin-top:8px">
                    <textarea v-model="bulkText" rows="6"
                        placeholder="product_name,selling_price,initial_stock,expiration_date,supplier_info&#10;Product A,10.50,100,2025-12-31,Supplier X"
                        style="width:100%; margin-top:8px; padding:10px; box-sizing:border-box"></textarea>
                    <div style="display:flex; gap:10px; margin-top:10px; align-items:center; flex-wrap:wrap">
                        <button class="btn" @click="startBulk" :disabled="bulkPosting">{{ bulkStartButtonText
                            }}</button>
                        <div class="muted">{{ bulkStatus }}</div>
                    </div>
                    <div v-if="bulkResults.length" style="margin-top:12px">
                        <div v-for="(r, i) in bulkResults" :key="i" style="padding:8px 0; border-bottom:1px solid #eee">
                            <div><strong>{{ r.product_name || '(no name)' }}</strong> — <span
                                    :style="{ color: r.ok ? '#155724' : '#721c24' }">{{ r.ok ? 'OK' : 'ERROR' }}</span>
                            </div>
                            <div v-if="r.message" class="muted">{{ r.message }}</div>
                        </div>
                    </div>
                </div>

                <div v-if="loading" style="padding:20px; text-align:center">Loading data...</div>

                <div v-if="errorMessage" :class="['status','error']" style="margin-top:16px">{{ errorMessage }}</div>

                <div v-if="!loading && products.length === 0" style="padding:20px; text-align:center" class="muted">No
                    product analytics available yet.</div>

                <div v-if="products.length > 0" class="table-responsive">
                    <table class="responsive-table" style="width:100%; min-width:720px; border-collapse:collapse;">
                        <thead>
                            <tr>
                                <th>Product Name</th>
                                <th>Selling Price</th>
                                <th>Initial Stock</th>
                                <th>Remaining Stock</th>
                                <th>Expiration Date</th>
                                <th>Supplier Info</th>
                                <th style="width:72px; text-align:center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(p, idx) in products" :key="p.id || idx">
                                <td>
                                    <template v-if="editRowId === p.id">
                                        <input class="form-input" v-model="editProduct.product_name">
                                    </template>
                                    <template v-else>{{ p.product_name || 'Unnamed product' }}</template>
                                </td>
                                <td>
                                    <template v-if="editRowId === p.id">
                                        <input class="form-input" v-model.number="editProduct.selling_price"
                                            type="number" step="0.01">
                                    </template>
                                    <template v-else>¢{{ formatNumber(p.selling_price) }}</template>
                                </td>
                                <td>
                                    <template v-if="editRowId === p.id">
                                        <input class="form-input" v-model.number="editProduct.initial_stock"
                                            type="number">
                                    </template>
                                    <template v-else>{{ p.initial_stock }}</template>
                                </td>
                                <td>{{ p.remaining_stock }}</td>
                                <td>
                                    <template v-if="editRowId === p.id">
                                        <input class="form-input" v-model="editProduct.expiration_date" type="date">
                                    </template>
                                    <template v-else>{{ formatDate(p.expiration_date) }}</template>
                                </td>
                                <td>
                                    <template v-if="editRowId === p.id">
                                        <input class="form-input" v-model="editProduct.supplier_info">
                                    </template>
                                    <template v-else>{{ p.supplier_info || '-' }}</template>
                                </td>
                                <td style="text-align:center">
                                    <div v-if="editRowId === p.id"
                                        style="display:flex; gap:8px; justify-content:center; flex-direction:column; align-items:center">
                                        <div style="display:flex; gap:8px;">
                                            <button class="btn" @click="saveEdit(p.id)"
                                                :disabled="editing">Save</button>
                                            <button class="btn" style="background:#fff;color:#000;border:1px solid #ddd"
                                                @click="cancelEdit">Cancel</button>
                                        </div>
                                        <div v-if="editMessage" :class="['status', editMessageType]"
                                            style="margin-top:8px">{{ editMessage }}</div>
                                    </div>
                                    <div v-else style="position:relative; display:inline-block">
                                        <button class="dot-btn" @click.stop="toggleMenu(p)">&#8942;</button>
                                        <div v-if="openMenuId === p.id" class="menu-dropdown">
                                            <button class="menu-item" @click.stop="startEditFromMenu(p, idx)">Edit
                                                data</button>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        try {
            const { createApp } = Vue;
            createApp({
                data() {
                    return {
                        business: '',
                        welcomeTitle: 'Welcome',
                        subtitle: "This is your dashboard. We'll build features here next.",
                        loading: false,
                        errorMessage: '',
                        products: [],
                        showPostForm: false,
                        posting: false,
                        postMessage: '',
                        postMessageType: '',
                        newProduct: {
                            product_name: '',
                            selling_price: '',
                            initial_stock: '',
                            expiration_date: '',
                            supplier_info: ''
                        },
                        showBulk: false,
                        bulkText: '',
                        bulkPosting: false,
                        bulkStatus: '',
                        bulkResults: [],
                        editRowId: null,
                        editIndex: -1,
                        editProduct: null,
                        editing: false,
                        openMenuId: null,
                        editMessage: '',
                        editMessageType: '',
                        editMessageTimer: null
                    }
                },
                computed: {
                    businessDisplay() {
                        return this.business || 'Not signed in';
                    },
                    postFormButtonText() {
                        return this.showPostForm ? 'Cancel' : 'Post product';
                    },
                    submitButtonText() {
                        return this.posting ? 'Posting...' : 'Submit product';
                    },
                    bulkButtonText() {
                        return this.showBulk ? 'Hide bulk uploader' : 'Post many products';
                    },
                    bulkStartButtonText() {
                        return this.bulkPosting ? 'Posting...' : 'Start bulk post';
                    }
                },
                mounted() {
                    try {
                        this.business = sessionStorage.getItem('nkwabiz_business') || '';
                    } catch (e) {
                        this.business = '';
                        console.warn('Could not access sessionStorage', e);
                    }
                    if (this.business) {
                        this.subtitle = `Business: ${this.business}`;
                        this.loadAnalytics();
                    }
                },
                methods: {
                    togglePostForm() {
                        this.showPostForm = !this.showPostForm;
                        if (this.showPostForm) this.showBulk = false;
                    },
                    toggleBulk() {
                        this.showBulk = !this.showBulk;
                        if (this.showBulk) this.showPostForm = false;
                    },
                    toggleMenu(p) {
                        if (this.openMenuId === p.id) {
                            this.openMenuId = null;
                            document.removeEventListener('click', this.handleDocClick);
                        } else {
                            this.openMenuId = p.id;
                            // close on outside click
                            setTimeout(() => document.addEventListener('click', this.handleDocClick));
                        }
                    },
                    handleDocClick(e) {
                        if (!e.target.closest || (!e.target.closest('.menu-dropdown') && !e.target.closest('.dot-btn'))) {
                            this.openMenuId = null;
                            document.removeEventListener('click', this.handleDocClick);
                        }
                    },
                    startEditFromMenu(p, idx) {
                        this.openMenuId = null;
                        this.startEdit(p, idx);
                        document.removeEventListener('click', this.handleDocClick);
                    },
                    startEdit(p, idx) {
                        // clear any prior messages/timers
                        if (this.editMessageTimer) {
                            clearTimeout(this.editMessageTimer);
                            this.editMessageTimer = null;
                        }
                        this.editMessage = '';
                        this.editMessageType = '';

                        this.editRowId = p.id;
                        this.editIndex = (typeof idx === 'number') ? idx : this.products.findIndex(x => x.id === p.id);
                        // shallow copy for editing
                        this.editProduct = {
                            product_name: p.product_name || '',
                            selling_price: p.selling_price || 0,
                            initial_stock: p.initial_stock || 0,
                            expiration_date: p.expiration_date || '',
                            supplier_info: p.supplier_info || ''
                        };
                    },
                    cancelEdit() {
                        this.editRowId = null;
                        this.editIndex = -1;
                        this.editProduct = null;
                        if (this.editMessageTimer) {
                            clearTimeout(this.editMessageTimer);
                            this.editMessageTimer = null;
                        }
                        this.editMessage = '';
                        this.editMessageType = '';
                    },
                    async saveEdit(productId) {
                        if (!this.editProduct) return;
                        this.editing = true;
                        try {
                            const payload = {
                                product_name: this.editProduct.product_name,
                                selling_price: this.editProduct.selling_price,
                                initial_stock: this.editProduct.initial_stock,
                                expiration_date: this.editProduct.expiration_date,
                                supplier_info: this.editProduct.supplier_info
                            };
                            const resp = await apiFetch(`https://saas-tool-mf02.onrender.com/product_view/product/${productId}`, {
                                method: 'PUT',
                                body: JSON.stringify(payload)
                            });
                            const data = await resp.json().catch(() => ({}));
                            if (!resp.ok) {
                                console.warn('Update failed', resp.status, data);
                                this.editMessage = data.message || `Update failed (status ${resp.status})`;
                                this.editMessageType = 'error';
                                return;
                            }
                            // update local products array
                            const idx = (this.editIndex > -1) ? this.editIndex : this.products.findIndex(x => x.id === productId);
                            if (idx > -1) {
                                // replace the exact index to avoid duplicates
                                this.$set ? this.$set(this.products, idx, Object.assign({}, this.products[idx], data.product || {})) : this.products.splice(idx, 1, Object.assign({}, this.products[idx], data.product || {}));
                            }
                            // show backend success message inline and auto-close the edit row
                            this.editMessage = data.message || 'Product updated successfully.';
                            this.editMessageType = 'success';
                            if (this.editMessageTimer) clearTimeout(this.editMessageTimer);
                            this.editMessageTimer = setTimeout(() => {
                                this.editRowId = null;
                                this.editIndex = -1;
                                this.editProduct = null;
                                this.editMessage = '';
                                this.editMessageType = '';
                                this.editMessageTimer = null;
                            }, 2500);
                        } catch (err) {
                            console.error('saveEdit error', err);
                            this.editMessage = 'Network error while updating product.';
                            this.editMessageType = 'error';
                        } finally {
                            this.editing = false;
                        }
                    },
                    formatNumber(v) {
                        if (v == null || v === '') return '-';
                        return Number(v).toLocaleString();
                    },
                    formatDate(d) {
                        if (!d) return '-';
                        const dt = new Date(d);
                        if (isNaN(dt)) return d;
                        return dt.toLocaleDateString();
                    },
                    async loadAnalytics() {
                        this.loading = true;
                        this.errorMessage = '';
                        try {
                            const resp = await apiFetch('https://saas-tool-mf02.onrender.com/dashboard/board', { method: 'GET' });
                            if (!resp.ok) {
                                let body = '';
                                try { body = await resp.text(); } catch (e) { }
                                this.errorMessage = `Failed to load analytics (status ${resp.status}).`;
                                console.warn('analytics load failed', resp.status, body);
                                return;
                            }
                            const data = await resp.json().catch(() => null);
                            if (Array.isArray(data)) {
                                this.products = data;
                            } else if (data && data.product_name) {
                                this.products = [data];
                            } else if (data && data.products && Array.isArray(data.products)) {
                                this.products = data.products;
                            } else {
                                this.products = [];
                            }
                        } catch (err) {
                            console.error('loadAnalytics error', err);
                            this.errorMessage = 'Network error while loading analytics.';
                        } finally {
                            this.loading = false;
                        }
                    },
                    async postProduct() {
                        this.posting = true;
                        this.postMessage = '';
                        this.postMessageType = '';
                        try {
                            const payload = {
                                product_name: this.newProduct.product_name,
                                selling_price: this.newProduct.selling_price,
                                initial_stock: this.newProduct.initial_stock,
                                expiration_date: this.newProduct.expiration_date,
                                supplier_info: this.newProduct.supplier_info
                            };
                            const resp = await apiFetch('https://saas-tool-mf02.onrender.com/product_view/product/post_product', {
                                method: 'POST',
                                body: JSON.stringify(payload)
                            });
                            const data = await resp.json().catch(() => ({}));
                            if (!resp.ok) {
                                const msg = data.message || `Failed to post product (status ${resp.status})`;
                                this.postMessage = msg;
                                this.postMessageType = 'error';
                                return;
                            }
                            this.postMessage = data.message || 'Product posted successfully.';
                            this.postMessageType = 'success';
                            this.newProduct = { product_name: '', selling_price: '', initial_stock: '', expiration_date: '', supplier_info: '' };
                            this.showPostForm = false;
                            this.loadAnalytics();
                        } catch (err) {
                            console.error('postProduct error', err);
                            this.postMessage = 'Network error while posting product.';
                            this.postMessageType = 'error';
                        } finally {
                            this.posting = false;
                        }
                    },
                    onFileChange(e) {
                        const f = e.target.files && e.target.files[0];
                        if (!f) return;
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                            this.bulkText = String(ev.target.result || '');
                        };
                        reader.readAsText(f);
                    },
                    parseCSV(text) {
                        const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
                        if (!lines.length) return [];
                        const header = lines[0].split(',').map(h => h.trim());
                        const rows = lines.slice(1).map(line => line.split(',').map(cell => cell.trim()));
                        return rows.map(cells => {
                            const obj = {};
                            for (let i = 0; i < header.length; i++) obj[header[i]] = cells[i] || '';
                            return obj;
                        });
                    },
                    async startBulk() {
                        const text = this.bulkText.trim();
                        if (!text) { this.bulkStatus = 'No CSV content'; return; }
                        this.bulkPosting = true;
                        this.bulkStatus = 'Parsing CSV...';
                        this.bulkResults = [];
                        try {
                            const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
                            let items = [];
                            if (lines[0] && lines[0].toLowerCase().includes('product_name')) {
                                items = this.parseCSV(text);
                            } else {
                                items = lines.map(line => {
                                    const c = line.split(',').map(s => s.trim());
                                    return {
                                        product_name: c[0] || '',
                                        selling_price: c[1] || '',
                                        initial_stock: c[2] || '',
                                        expiration_date: c[3] || '',
                                        supplier_info: c[4] || ''
                                    };
                                });
                            }
                            this.bulkStatus = `Posting ${items.length} items...`;
                            for (let i = 0; i < items.length; i++) {
                                const it = items[i];
                                try {
                                    const payload = {
                                        product_name: it.product_name,
                                        selling_price: it.selling_price,
                                        initial_stock: it.initial_stock,
                                        expiration_date: it.expiration_date,
                                        supplier_info: it.supplier_info
                                    };
                                    const resp = await apiFetch('https://saas-tool-mf02.onrender.com/product_view/product/post_product', {
                                        method: 'POST',
                                        body: JSON.stringify(payload)
                                    });
                                    const data = await resp.json().catch(() => ({}));
                                    if (!resp.ok) {
                                        this.bulkResults.push({ ...it, ok: false, message: data.message || `status ${resp.status}` });
                                    } else {
                                        this.bulkResults.push({ ...it, ok: true, message: data.message || 'OK' });
                                    }
                                } catch (err) {
                                    this.bulkResults.push({ ...it, ok: false, message: 'Network error' });
                                }
                                this.bulkStatus = `Posted ${i + 1}/${items.length}`;
                            }
                            this.bulkStatus = `Done: ${this.bulkResults.filter(r => r.ok).length} succeeded, ${this.bulkResults.filter(r => !r.ok).length} failed.`;
                            this.loadAnalytics();
                        } finally {
                            this.bulkPosting = false;
                        }
                    },
                    signout() {
                        try {
                            sessionStorage.removeItem('nkwabiz_token');
                            sessionStorage.removeItem('nkwabiz_business');
                        } catch (e) {
                            console.warn('Could not clear sessionStorage', e);
                        }
                        window.location.href = 'index.html';
                    }
                }
            }).mount('#app');
        } catch (e) {
            console.error('Dashboard init error', e);
            try {
                const node = document.createElement('pre');
                node.id = 'dashboard-error';
                node.style.background = '#fee';
                node.style.color = '#900';
                node.style.padding = '12px';
                node.style.margin = '20px';
                node.textContent = String(e && e.stack ? e.stack : e);
                document.body.insertBefore(node, document.body.firstChild);
            } catch (inner) { }
        }
    </script>
</body>

</